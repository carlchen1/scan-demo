<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>H5 条码/二维码扫码</title>
  <!-- ZXing 条码识别库 -->
  <script src="https://cdn.jsdelivr.net/npm/@zxing/library@0.20.0/umd/index.min.js"></script>
  <style>
    :root {
      --radius: 18px;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0; padding: 16px; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial;
      background: #0b0f14; color: #e7edf3;
    }
    .wrap { max-width: 820px; margin: 0 auto; }
    h1 { font-size: 20px; margin: 0 0 12px; }
    .card { background: #121821; border: 1px solid #223042; border-radius: var(--radius); padding: 12px; box-shadow: 0 8px 24px rgba(0,0,0,.35); }
    .row { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; }
    button, select, input[type="text"] {
      border: 1px solid #2a3b52; background: #0f1520; color: #e7edf3; border-radius: 12px; padding: 10px 12px; font-size: 14px;
    }
    button { cursor: pointer; }
    button:disabled { opacity: .6; cursor: not-allowed; }
    .video-box { position: relative; border-radius: var(--radius); overflow: hidden; border: 1px solid #223042; }
    video { width: 100%; height: auto; background: #000; }
    /* 扫描框遮罩 */
    .scan-mask::after {
      content: ""; position: absolute; inset: 0; pointer-events: none;
      background:
        linear-gradient(to right, rgba(0,0,0,.55) 0, rgba(0,0,0,.55) calc(50% - 130px), transparent calc(50% - 130px), transparent calc(50% + 130px), rgba(0,0,0,.55) calc(50% + 130px), rgba(0,0,0,.55) 100%),
        linear-gradient(to bottom, rgba(0,0,0,.55) 0, rgba(0,0,0,.55) calc(50% - 130px), transparent calc(50% - 130px), transparent calc(50% + 130px), rgba(0,0,0,.55) calc(50% + 130px), rgba(0,0,0,.55) 100%);
    }
    .scan-box { position: absolute; width: 260px; height: 260px; left: 50%; top: 50%; transform: translate(-50%,-50%); border-radius: 18px; box-shadow: 0 0 0 2px rgba(87,186,255,.9) inset; }
    .scan-line { position: absolute; left: 8px; right: 8px; height: 2px; top: 12px; background: #57baff; animation: scan 2s linear infinite; border-radius: 2px; }
    @keyframes scan { 0% { top: 12px; } 100% { top: calc(100% - 12px); } }

    .result { margin-top: 10px; padding: 10px; border-radius: 12px; background: #0f1520; border: 1px solid #2a3b52; word-break: break-all; }
    .muted { color: #8aa0b7; font-size: 13px; }
    .ok { color: #70e281; font-weight: 600; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>H5 条码/二维码扫码</h1>
    <div class="card" style="margin-bottom:12px">
      <div class="row" style="gap:10px">
        <label>
          摄像头：
          <select id="cameraSelect"></select>
        </label>
        <button id="btnStart">开始</button>
        <button id="btnStop" disabled>停止</button>
        <button id="btnTorch" disabled>手电/闪光</button>
        <label class="row" style="gap:6px">
          <input type="checkbox" id="cbContinuous" checked /> 连续扫码
        </label>
      </div>
      <div class="muted" style="margin-top:6px">提示：请在 HTTPS 环境（或本地 http://localhost）打开本页面，并允许相机权限。iOS Safari 需使用 <span style="font-family:monospace">playsinline</span>，页面已适配。</div>
    </div>

    <div class="video-box scan-mask">
      <video id="preview" playsinline muted></video>
      <div class="scan-box"><div class="scan-line"></div></div>
    </div>

    <div class="card" style="margin-top:12px">
      <div class="row" style="gap:6px; align-items: stretch">
        <input id="txtResult" type="text" placeholder="识别结果会显示在这里" style="flex:1" readonly />
        <button id="btnCopy" disabled>复制</button>
      </div>
      <div id="hint" class="muted" style="margin-top:6px">支持常见一维码（Code128、EAN-13、EAN-8 等）与二维码（QR Code）。</div>
    </div>
  </div>

  <audio id="beep" preload="auto">
    <source src="https://cdn.jsdelivr.net/gh/nao20010128nao/misc-audio/beep-07.wav" type="audio/wav" />
  </audio>

  <script>
    const { BrowserMultiFormatReader, NotFoundException } = ZXing;
    const codeReader = new BrowserMultiFormatReader();

    const els = {
      video: document.getElementById('preview'),
      camSel: document.getElementById('cameraSelect'),
      start: document.getElementById('btnStart'),
      stop: document.getElementById('btnStop'),
      torch: document.getElementById('btnTorch'),
      result: document.getElementById('txtResult'),
      copy: document.getElementById('btnCopy'),
      beep: document.getElementById('beep'),
      hint: document.getElementById('hint'),
      cbContinuous: document.getElementById('cbContinuous'),
    };

    let currentDeviceId = null;
    let currentStream = null;
    let decoding = false;
    let lastPlay = 0;

    async function listCameras() {
      try {
        const devices = await navigator.mediaDevices.enumerateDevices();
        const cams = devices.filter(d => d.kind === 'videoinput');
        els.camSel.innerHTML = '';
        cams.forEach((c, idx) => {
          const opt = document.createElement('option');
          opt.value = c.deviceId;
          opt.textContent = c.label || `摄像头 ${idx + 1}`;
          els.camSel.appendChild(opt);
        });
        // 选后置（environment）
        const env = cams.find(c => /back|rear|environment/i.test(c.label));
        if (env) els.camSel.value = env.deviceId;
        currentDeviceId = els.camSel.value || (cams[0] && cams[0].deviceId) || null;
        els.start.disabled = !currentDeviceId;
      } catch (e) {
        console.error(e);
        els.hint.textContent = '无法获取摄像头列表：' + e;
      }
    }

    async function start() {
      if (decoding) return;
      try {
        els.start.disabled = true;
        els.stop.disabled = false;
        els.torch.disabled = true;

        currentDeviceId = els.camSel.value || currentDeviceId;
        await stop();

        // 优先尝试后置相机
        const constraints = currentDeviceId ? { video: { deviceId: { exact: currentDeviceId } } } : { video: { facingMode: { ideal: 'environment' } } };
        currentStream = await navigator.mediaDevices.getUserMedia(constraints);
        els.video.srcObject = currentStream;
        await els.video.play();

        // Torch 可用性检测
        const track = currentStream.getVideoTracks()[0];
        const capabilities = track.getCapabilities?.();
        const canTorch = capabilities && 'torch' in capabilities;
        els.torch.disabled = !canTorch;

        decoding = true;
        codeReader.decodeFromVideoDevice(currentDeviceId || undefined, els.video, (result, err) => {
          if (result) onDecoded(result.getText());
          // 忽略 NotFoundException 以保持持续扫描
          if (err && !(err instanceof NotFoundException)) {
            console.warn(err);
          }
        });
      } catch (e) {
        console.error(e);
        els.hint.textContent = '启动失败：' + e;
        els.start.disabled = false;
        els.stop.disabled = true;
      }
    }

    async function stop() {
      decoding = false;
      try { codeReader.reset(); } catch {}
      if (currentStream) {
        currentStream.getTracks().forEach(t => t.stop());
        currentStream = null;
      }
      els.stop.disabled = true;
      els.start.disabled = false;
    }

    async function toggleTorch() {
      if (!currentStream) return;
      const track = currentStream.getVideoTracks()[0];
      const capabilities = track.getCapabilities?.();
      if (!capabilities || !('torch' in capabilities)) return;
      const settings = track.getSettings();
      const torchOn = !settings.torch;
      try {
        await track.applyConstraints({ advanced: [{ torch: torchOn }] });
      } catch (e) { console.warn('Torch 不支持：', e); }
    }

    function onDecoded(text) {
      // 防抖：同一结果在 1s 内不重复提示
      const now = Date.now();
      if (els.result.value === text && now - lastPlay < 1000) return;

      els.result.value = text;
      els.copy.disabled = !text;
      try { els.beep.currentTime = 0; els.beep.play(); } catch {}
      if (navigator.vibrate) navigator.vibrate(80);

      // 如果不是连续模式，则自动停止
      if (!els.cbContinuous.checked) {
        stop();
      }
      lastPlay = now;
      // 这里可以加：自动回调到你的业务接口
      // fetch('/api/scan', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ code: text })});
    }

    // 复制
    els.copy.addEventListener('click', async () => {
      try {
        await navigator.clipboard.writeText(els.result.value || '');
        els.hint.innerHTML = '<span class="ok">已复制到剪贴板</span>';
      } catch (e) {
        els.hint.textContent = '复制失败：' + e;
      }
    });

    // 事件绑定
    els.start.addEventListener('click', start);
    els.stop.addEventListener('click', stop);
    els.torch.addEventListener('click', toggleTorch);
    els.camSel.addEventListener('change', () => { if (decoding) start(); });

    // 首次尝试获取权限并列出摄像头（需用户交互后更稳定）
    (async () => {
      if (!navigator.mediaDevices?.getUserMedia) {
        els.hint.textContent = '当前浏览器不支持相机访问（需要 HTTPS + MediaDevices）。';
        return;
      }
      await listCameras();
    })();
  </script>
</body>
</html>
